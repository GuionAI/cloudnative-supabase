{{- if or .Values.jwt.secretRef .Values.cluster.bootstrap.extraSQL }}
apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ include "cnpg-cluster.fullname" . }}-init-sql
  namespace: {{ .Release.Namespace }}
  labels:
    {{- include "cnpg-cluster.labels" . | nindent 4 }}
data:
  init.sql: |
    {{- if .Values.jwt.secretRef }}
    -- Set JWT settings on database (required for RLS policies)
    -- Variables are substituted by CNPG from env section
    ALTER DATABASE {{ .Values.cluster.bootstrap.database }} SET "app.settings.jwt_secret" TO '$(JWT_SECRET)';
    ALTER DATABASE {{ .Values.cluster.bootstrap.database }} SET "app.settings.jwt_exp" TO '$(JWT_EXP)';
    {{- end }}
    {{- if .Values.cluster.bootstrap.extraSQL }}
    -- Custom SQL from values
{{ .Values.cluster.bootstrap.extraSQL | indent 4 }}
    {{- end }}
{{- end }}
