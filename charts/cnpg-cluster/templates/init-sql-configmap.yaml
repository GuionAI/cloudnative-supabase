{{- /* Init SQL for grants and JWT settings (roles/schemas managed by CNPG) */ -}}
apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ include "cnpg-cluster.fullname" . }}-init-sql
  namespace: {{ .Release.Namespace }}
  labels:
    {{- include "cnpg-cluster.labels" . | nindent 4 }}
data:
  init.sql: |
    -- ============================================
    -- Supabase Database Initialization SQL
    -- ============================================
    -- This runs during bootstrap BEFORE managed.roles and Database CRD.
    -- We create api_access_role and extensions schema here so GRANTs work.
    -- CNPG will reconcile roles/schemas later (idempotent).
    -- ============================================

    -- 1. Create api_access_role (group role for API permissions)
    CREATE ROLE api_access_role NOLOGIN;

    -- 2. Create extensions schema (referenced in GRANT below)
    CREATE SCHEMA IF NOT EXISTS extensions;

    {{- if .Values.jwt.secretRef }}
    -- 3. JWT settings (required for RLS policies)
    ALTER DATABASE {{ .Values.cluster.bootstrap.database }} SET "app.settings.jwt_secret" TO '$(JWT_SECRET)';
    ALTER DATABASE {{ .Values.cluster.bootstrap.database }} SET "app.settings.jwt_exp" TO '$(JWT_EXP)';
    {{- end }}

    -- 4. Grant API access via group role (anon/authenticated/service_role inherit later)
    GRANT USAGE ON SCHEMA public TO api_access_role;
    GRANT USAGE ON SCHEMA extensions TO api_access_role;

    -- Default privileges for future objects in public schema
    ALTER DEFAULT PRIVILEGES IN SCHEMA public GRANT ALL ON TABLES TO api_access_role;
    ALTER DEFAULT PRIVILEGES IN SCHEMA public GRANT ALL ON FUNCTIONS TO api_access_role;
    ALTER DEFAULT PRIVILEGES IN SCHEMA public GRANT ALL ON SEQUENCES TO api_access_role;

    {{- if .Values.cluster.bootstrap.extraSQL }}
    -- 5. Custom SQL from values
{{ .Values.cluster.bootstrap.extraSQL | indent 4 }}
    {{- end }}
